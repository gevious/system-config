#!/usr/bin/env bash
set -euo pipefail

NOTES_DIR="$HOME/w/notes"
# Environment for GUI notifications
export DISPLAY=:0
export XDG_RUNTIME_DIR="/run/user/$(id -u)"

notify() {
    local msg="${1:-Git auto-push failed}"
    # Use DISPLAY and DBUS_SESSION_BUS_ADDRESS for systemd timers
    export DISPLAY=:0
    export XDG_RUNTIME_DIR="/run/user/$(id -u)"
    notify-send "Notes pusher" "$msg" -u critical
}

notify_exit() {
    local msg="$1"
    notify "$msg"
    exit 0
}

# Trap any error
trap 'notify_exit "push-notes failed at line $LINENO"' ERR

cd "$NOTES_DIR"

if [ ! -d "$NOTES_DIR" ]; then
  notify_exit "notes directory doesn't exist: $NOTES_DIR"
fi

# Exit if not a git repo
git rev-parse --is-inside-work-tree >/dev/null 2>&1 || notify_exit "$NOTES_DIR is not a git repo"

# Exit if no changes
if git diff --quiet && git diff --cached --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
    # No changes and no untracked files
  notify_exit "No changes to commit"
fi

git add -A
git commit -m "Auto commit $(date '+%Y-%m-%d %H:%M:%S')" || exit 0
git pull
if git push; then
    exit 0
else
    notify "Failed to push notes"
fi
